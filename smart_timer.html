<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Timers</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN for sound generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Custom styles for the Inter font and overall body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to start for better scrolling on content-heavy pages */
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Container for the app, ensuring responsiveness */
        .config-container, .create-timer-container, .timer-screen-container {
            background-color: #ffffff; /* White background fallback */
            background-image: linear-gradient(135deg, #e0e7ff 0%, #f0f2f5 100%); /* Subtle blue-gray gradient */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); /* More prominent shadow */
            border-radius: 25px; /* More rounded corners */
            padding: 30px;
            width: 100%;
            max-width: 800px; /* Max-width for home and create pages */
            display: flex;
            flex-direction: column;
            gap: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3); /* Soft, subtle border */
        }
        .timer-screen-container {
            max-width: 500px; /* Specific max-width for timer screen */
            align-items: center;
            justify-content: center;
            min-height: 400px;
            text-align: center;
        }

        /* List styling */
        .config-list, .preset-list {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        /* Individual list item styling */
        .config-item, .preset-item {
            background-color: rgba(255, 255, 255, 0.4); /* Semi-transparent white for glass */
            backdrop-filter: blur(10px); /* Frosted glass effect */
            border-radius: 15px; /* Slightly more rounded */
            padding: 10px 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1), /* Soft shadow */
                        0 0 0 1px rgba(255, 255, 255, 0.2) inset; /* Inner light border */
            transition: transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: space-between; /* Space out items */
            gap: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3); /* White border for glass effect */
        }

        .config-item:last-child, .preset-item:last-child {
            margin-bottom: 0;
        }

        .config-item:hover, .preset-item:hover {
            transform: translateY(-3px); /* More pronounced lift on hover */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15),
                        0 0 0 1px rgba(255, 255, 255, 0.4) inset;
        }

        .item-index {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333; /* Darker text for readability */
            min-width: 25px;
            text-align: center;
            flex-shrink: 0;
        }

        .item-name {
            font-size: 1rem;
            font-weight: bold;
            color: #4a5568;
            white-space: nowrap; /* Prevent wrapping */
            overflow: hidden; /* Hide overflow text */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            flex-grow: 1; /* Allow to take available space */
            margin-right: 15px; /* Space before buttons */
        }

        /* Common button styles for action buttons (play, remove, add preset) */
        .action-button {
            background-color: rgba(255, 255, 255, 0.2); /* Semi-transparent white */
            backdrop-filter: blur(5px); /* Less blur for smaller buttons */
            color: #4a5568; /* Darker text for contrast */
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 9999px;
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .action-button:hover {
            background-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: none;
            transform: translateY(0);
        }

        /* Specific style for the Start button on the main list */
        .start-button {
            background-color: rgba(60, 179, 113, 0.3); /* Greenish tint for main start button */
            border-color: rgba(60, 179, 113, 0.4);
            color: #ffffff;
            box-shadow: 0 2px 5px rgba(60, 179, 113, 0.2);
        }

        .start-button:hover {
            background-color: rgba(60, 179, 113, 0.5);
            box-shadow: 0 3px 8px rgba(60, 179, 113, 0.3);
        }

        /* Specific style for the Remove button on the main list */
        .remove-button {
            background-color: rgba(220, 53, 69, 0.3); /* Reddish tint for remove button */
            border-color: rgba(220, 53, 69, 0.4);
            color: #ffffff;
            box-shadow: 0 2px 5px rgba(220, 53, 69, 0.2);
            margin-left: 10px; /* Add some margin to separate from start button */
        }

        .remove-button:hover {
            background-color: rgba(220, 53, 69, 0.5);
            box-shadow: 0 3px 8px rgba(220, 53, 69, 0.3);
        }

        /* Specific style for the Add Preset button */
        .add-preset-button {
            background-color: rgba(66, 153, 225, 0.3); /* Blueish tint for add preset button */
            border-color: rgba(66, 153, 225, 0.4);
            color: #ffffff;
            box-shadow: 0 2px 5px rgba(66, 153, 225, 0.2);
        }

        .add-preset-button:hover {
            background-color: rgba(66, 153, 225, 0.5);
            box-shadow: 0 3px 8px rgba(66, 153, 225, 0.3);
        }


        /* Timer Screen specific styles (remains mostly the same as last iteration, but vibrant) */
        .timer-screen-title {
            font-size: 2.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            /* Ensure text wraps */
            white-space: normal;
            word-break: break-word;
        }

        .timer-display {
            font-size: 5rem;
            font-weight: bolder;
            color: #4299e1;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            margin-top: 20px;
            margin-bottom: 30px;
            letter-spacing: 2px;
        }

        .timer-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }

        /* Primary control button (Start) - Green Glass - More Vibrant */
        .control-button {
            background-color: rgba(60, 179, 113, 0.5); /* Increased opacity for vibrancy */
            backdrop-filter: blur(12px); /* Slightly more blur */
            border: 1px solid rgba(255, 255, 255, 0.5); /* More prominent border */
            color: #ffffff;
            border-radius: 9999px;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 10px 30px rgba(60, 179, 113, 0.4), /* Stronger shadow */
                        0 0 0 2px rgba(255, 255, 255, 0.3) inset; /* Stronger inner highlight */
        }

        .control-button:hover {
            background-color: rgba(60, 179, 113, 0.7); /* Even more opaque on hover */
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(60, 179, 113, 0.5),
                        0 0 0 3px rgba(255, 255, 255, 0.4) inset;
        }

        /* Secondary control button (Pause) - Blue Glass - More Vibrant */
        .control-button.secondary {
            background-color: rgba(65, 105, 225, 0.5); /* Increased opacity for vibrancy */
            box-shadow: 0 10px 30px rgba(65, 105, 225, 0.4), /* Stronger shadow */
                        0 0 0 2px rgba(255, 255, 255, 0.3) inset;
        }

        .control-button.secondary:hover {
            background-color: rgba(65, 105, 225, 0.7); /* Even more opaque on hover */
            box-shadow: 0 15px 40px rgba(65, 105, 225, 0.5),
                        0 0 0 3px rgba(255, 255, 255, 0.4) inset;
        }

        /* Disabled state for all control buttons (consistent with previous, but adapted to new vibrancy) */
        .control-button:disabled {
            background-color: rgba(176, 176, 176, 0.3); /* Slightly more transparent grey for disabled */
            color: rgba(255, 255, 255, 0.5); /* Slightly less opaque text */
            cursor: not-allowed;
            opacity: 0.8;
            box-shadow: none;
            transform: translateY(0);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Back button - Cornflower Blue Glass - More Vibrant */
        .back-button {
            background-color: rgba(100, 149, 237, 0.5); /* Increased opacity for vibrancy */
            backdrop-filter: blur(12px); /* Slightly more blur */
            border: 1px solid rgba(255, 255, 255, 0.5); /* More prominent border */
            color: #ffffff;
            border-radius: 9999px;
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(100, 149, 237, 0.4),
                        0 0 0 2px rgba(255, 255, 255, 0.3) inset;
        }

        .back-button:hover {
            background-color: rgba(100, 149, 237, 0.7); /* Even more opaque on hover */
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(100, 149, 237, 0.5),
                        0 0 0 3px rgba(255, 255, 255, 0.4) inset;
        }

        /* Done Screen styles */
        .done-screen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .done-screen-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .done-message-box {
            background-color: #fff;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            font-size: 3rem;
            font-weight: bold;
            color: #28a745;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease-out;
        }

        .done-screen-overlay.visible .done-message-box {
            transform: scale(1);
        }

        /* Styles for the new Create Timer page */
        .create-timer-form label {
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 8px;
            display: block;
        }
        .create-timer-form input[type="text"] {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background-color: rgba(255, 255, 255, 0.2);
            color: #333;
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; /* Added border and shadow to transition */
            margin-bottom: 15px; /* Space between fields */
        }
        .create-timer-form input[type="text"]:focus {
            outline: none;
            border-color: rgba(66, 153, 225, 0.6);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }
        /* New style for invalid input */
        .create-timer-form input[type="text"].input-invalid {
            border-color: #ef4444; /* Red border for invalid state */
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3); /* Red glow for invalid state */
        }

        .form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }

        /* Styles for individual timer steps in create page */
        .timer-steps-container {
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.2);
            max-height: 400px; /* Limit height for scrollability */
            overflow-y: auto;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }

        .dynamic-step-items-wrapper { /* New style for the wrapper */
            padding-bottom: 15px; /* Space between steps and controls */
        }

        .timer-step-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            padding: 8px 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid rgba(255, 255, 255, 0.7);
        }

        .timer-step-item:last-child {
            margin-bottom: 0;
        }

        .step-index {
            font-weight: bold;
            color: #555;
            min-width: 20px;
            text-align: center;
        }

        .step-label-select, .step-duration-select {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.7);
            background-color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            color: #4a5568;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%23666"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 1em;
            cursor: pointer;
            flex-grow: 1; /* Allow these selects to grow */
            min-width: 80px;
        }

        .step-action-checkbox {
            display: flex; /* Make label a flex container */
            align-items: center; /* Vertically center its contents */
            gap: 4px;
            font-size: 0.85rem;
            color: #555;
            white-space: nowrap;
        }
        .step-action-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #a0aec0;
            cursor: pointer;
            flex-shrink: 0;
        }
        .step-action-checkbox input[type="checkbox"]:checked {
            background-color: #4299e1;
            border-color: #4299e1;
        }
        .step-action-checkbox svg {
            width: 18px;
            height: 18px;
        }

        .step-footer-controls { /* New style for the footer container */
            display: flex;
            justify-content: flex-end; /* Push content to the right */
            align-items: center; /* Vertically align items */
            gap: 10px; /* Space between the plus button and repeat control */
            padding-top: 15px; /* Space from the dynamic steps above */
            border-top: 1px solid rgba(255, 255, 255, 0.4); /* Separator line */
            margin-top: 10px; /* Space from the last step item */
            width: fit-content; /* Make the footer only as wide as its content */
            margin-left: auto;  /* Push it to the right */
            margin-right: 0; /* Ensure no extra right margin */
        }

        .step-footer-controls .action-button { /* Re-using action-button for plus */
            width: 32px; /* Smaller width */
            height: 32px; /* Smaller height */
            font-size: 1.2rem; /* Smaller plus sign */
            border-radius: 50%; /* Circular */
            background-color: rgba(60, 179, 113, 0.4);
            border: 1px solid rgba(60, 179, 113, 0.5);
            color: #ffffff;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1); /* Adjusted shadow for smaller size */
        }
        .step-footer-controls .action-button:hover {
            background-color: rgba(60, 179, 113, 0.6);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        /* Style for the new repeat select element to match the plus button */
        #repeatTimesSelect {
            width: 32px;
            height: 32px;
            line-height: 32px; /* Match height for vertical centering of text */
            border-radius: 50%; /* Make it circular */
            padding: 0 2px; /* Adjust padding for better text centering */
            font-size: 0.85rem; /* Adjust font size to fit */
            text-align: center; /* Center the text */
            appearance: none; /* Remove default dropdown arrow */
            background-image: none; /* Remove custom background image (arrow) */
            background-color: rgba(66, 153, 225, 0.4); /* Match add preset button color */
            border: 1px solid rgba(66, 153, 225, 0.5);
            color: #ffffff;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            flex-shrink: 0; /* Prevent it from shrinking */
            /* Removed display: flex and related centering as select is tricky */
        }

        #repeatTimesSelect:hover {
            background-color: rgba(66, 153, 225, 0.6);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }


        .remove-step-item-button { /* Specific style for step item remove */
            background-color: rgba(220, 53, 69, 0.2); /* Lighter red */
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #ffffff;
            width: 28px; /* Smaller button */
            height: 28px;
            font-size: 0.8rem;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            flex-shrink: 0;
            margin-left: auto; /* Push to the right */
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .remove-step-item-button:hover {
            background-color: rgba(220, 53, 69, 0.4);
            box-shadow: 0 2px 5px rgba(0,0,0,0.12);
        }
        .remove-step-item-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }


        /* Utility classes */
        .hidden {
            display: none !important;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .config-item, .preset-item {
                flex-wrap: wrap;
                gap: 10px;
                padding: 10px;
            }
            .item-name {
                flex-grow: 1;
                margin-right: 0;
            }
            .item-index {
                font-size: 1rem;
                min-width: 20px;
            }
            .action-button {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }
            .icon-size {
                width: 18px;
                height: 18px;
            }
            .timer-screen-container, .create-timer-container {
                padding: 20px;
                border-radius: 15px;
            }
            .timer-screen-title {
                font-size: 1.8rem;
            }
            .timer-display {
                font-size: 3.5rem;
            }
            .control-button {
                padding: 10px 20px;
                font-size: 1rem;
            }
            .back-button {
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            .done-message-box {
                font-size: 2rem;
                padding: 30px;
            }
            .create-timer-form input {
                padding: 10px;
            }
            .form-buttons {
                flex-direction: column;
                gap: 10px;
            }
            .form-buttons .control-button {
                width: 100%;
            }
            .timer-step-item {
                flex-wrap: wrap;
                gap: 8px;
                padding: 6px 10px;
            }
            .step-label-select, .step-duration-select {
                flex-grow: unset; /* Don't let them grow too much on small screens */
                width: calc(50% - 20px); /* Adjust width */
                min-width: unset;
            }
            .step-action-checkbox {
                flex-basis: 45%; /* Arrange checkboxes side by side */
                justify-content: center;
            }
            .step-footer-controls {
                /* On smaller screens, keep as row, align to end */
                flex-direction: row;
                justify-content: flex-end;
                align-items: center;
                gap: 10px;
                width: 100%; /* Take full width on small screens */
                margin-left: 0; /* Remove auto margin */
            }
            .step-footer-controls .action-button {
                width: 32px; /* Match standard size */
                height: 32px;
                font-size: 1.2rem;
            }
            .remove-step-item-button {
                width: 24px;
                height: 24px;
            }
        }
        @media (max-width: 480px) {
             .config-container, .timer-screen-container, .create-timer-container {
                padding: 15px;
             }
             .config-item, .preset-item {
                 padding: 8px 10px;
                 gap: 8px;
             }
            .timer-display {
                font-size: 3rem;
            }
            .timer-controls {
                flex-direction: column;
                gap: 10px;
            }
            .control-button {
                width: 100%;
                padding: 12px;
            }
            .back-button {
                width: 100%;
            }
            .done-message-box {
                font-size: 1.5rem;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="configListScreen" class="config-container">
        <h1 class="text-3xl font-bold text-gray-800 text-center">Smart Timers</h1>
        <ul id="timerConfigList" class="config-list">
            <!-- Timer configurations will be loaded here by JavaScript -->
        </ul>
        <button id="addCustomTimerButton" class="control-button mt-4 w-full">Create Custom Timer</button>

        <!-- New container for preset timers -->
        <h2 class="text-2xl font-bold text-gray-700 text-center mt-8 mb-4">Preset Timers</h2>
        <ul id="presetTimersList" class="preset-list">
            <!-- Preset timer configurations will be loaded here by JavaScript -->
        </ul>
    </div>

    <div id="createTimerScreen" class="hidden create-timer-container">
        <h2 class="text-3xl font-bold text-gray-800 text-center">Create New Timer</h2>
        <div class="create-timer-form">
            <label for="newTimerName">Timer Name:</label>
            <input type="text" id="newTimerName" placeholder="e.g., Study Session" required>
            <!-- New UI Hint for Timer Name -->
            <div id="timerNameHint" class="text-red-500 text-sm mt-1 hidden">Please enter a timer name.</div>


            <h3 class="text-xl font-bold text-gray-700 mt-6 mb-3">Timer Steps:</h3>
            <div id="timerStepsContainer" class="timer-steps-container">
                <div id="dynamicStepItemsWrapper" class="dynamic-step-items-wrapper">
                    <!-- Dynamic timer steps will be added here by JavaScript -->
                </div>

                <div id="stepConfigFooter" class="step-footer-controls">
                    <button id="addStepButton" class="action-button">+</button>
                    <!-- Repeat Times Select Menu -->
                    <select id="repeatTimesSelect" class="rounded-lg border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
            </div>


            <div class="form-buttons">
                <button id="createTimerConfirmButton" class="control-button">Submit</button>
                <button id="cancelCreateTimerButton" class="control-button secondary">Cancel</button>
            </div>
        </div>
    </div>


    <div id="timerScreen" class="hidden timer-screen-container">
        <h2 class="timer-screen-title" id="timerScreenTitle">Quick Break</h2>
        <div class="timer-display" id="currentTimerDisplay">00:00</div>
        <div class="timer-controls">
            <button id="startButtonTimer" class="control-button">Start</button>
            <button id="pauseButtonTimer" class="control-button secondary">Pause</button>
        </div>
        <button id="backButton" class="back-button">Back to Home</button>
    </div>

    <!-- Done Screen Overlay -->
    <div id="doneScreen" class="done-screen-overlay">
        <div class="done-message-box">Done!</div>
    </div>

    <script>
        // MARK: - Timer Configuration Data Models (JavaScript Equivalent)

        // Represents a single step within a multi-step timer.
        class TimerStep {
            constructor(type, duration, hasVoiceAction, hasVibrationAction) {
                this.type = type; // "Work" or "Rest"
                this.duration = duration; // in seconds
                this.hasVoiceAction = hasVoiceAction;
                this.hasVibrationAction = hasVibrationAction;
            }
        }

        // Represents a single timer configuration item, now supporting multiple steps.
        class TimerConfiguration {
            // New constructor: repeatCount instead of shouldRepeat and repeatLogic
            constructor(name, steps, repeatCount = 1) {
                this.id = this.generateUUID(); // Unique identifier for list rendering.
                this.name = name;
                this.steps = steps;
                this.repeatCount = repeatCount; // Number of times the entire timer sequence repeats (1 for no repeat)
            }

            generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
        }

        // Default configurations for the main list
        const timerConfigurations = [
            new TimerConfiguration("Quick Break", [new TimerStep("Work", 60, true, true)], 1) // Default to 1x repeat
        ];

        // Default configurations for the preset list
        const presetTimerConfigurations = [
            new TimerConfiguration("Focus Study", [
                new TimerStep("Work", 1500, true, true), // 25 minutes
                new TimerStep("Rest", 300, true, true)    // 5 minutes
            ], 3), // Example: Repeat 3 times
            new TimerConfiguration("HIIT", [
                new TimerStep("Work", 30, true, true),
                new TimerStep("Rest", 30, false, true)
            ], 5) // Example: Repeat 5 times
        ];

        // Options for step duration dropdown (10 seconds to 5 minutes)
        const stepDurationOptions = [
            { value: 10, text: "10s" },
            { value: 15, text: "15s" },
            { value: 20, text: "20s" },
            { value: 30, text: "30s" },
            { value: 45, text: "45s" },
            { value: 60, text: "1 min" },
            { value: 90, text: "1.5 min" },
            { value: 120, text: "2 min" },
            { value: 180, text: "3 min" },
            { value: 240, text: "4 min" },
            { value: 300, text: "5 min" },
            { value: 600, text: "10 min" },
            { value: 900, text: "15 min" },
            { value: 1200, text: "20 min" },
            { value: 1500, text: "25 min" },
            { value: 1800, text: "30 min" },
            { value: 2700, text: "45 min" },
            { value: 3600, text: "1 hour" }
        ];

        // MARK: - SVG Icons (Inline for iOS-like appearance)
        const svgIcons = {
            play: `<svg class="icon-size" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`,
            remove: `<svg class="icon-size" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>`,
            add: `<svg class="icon-size" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>`,
            voice: `<svg class="icon-size" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C10.34 2 9 3.34 9 5v6c0 1.66 1.34 3 3 3s3-1.34 3-3V5c0-1.66-1.34-3-3-3zM21 12v1c0 3.87-3.13 7-7 7h-4c-3.87 0-7-3.13-7-7v-1h2v1c0 2.76 2.24 5 5 5h4c2.76 0 5-2.24 5-5v-1h2z"/></svg>`,
            vibration: `<svg class="icon-size" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 4h10c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2zm0 2v12h10V6H7zM3 7h1v10H3zm17 0h1v10h-1z"/></svg>`
        };

        // MARK: - Audio Context and Synth for Voice Action
        let synth;

        /**
         * Initializes Tone.js synth. Should be called after user interaction to unlock audio context.
         */
        function initializeAudio() {
            if (!synth) {
                // Initialize Tone.js only once
                synth = new Tone.Synth().toDestination();
                console.log("Tone.js synth initialized.");
            }
        }

        /**
         * Plays a simple beep sound.
         */
        async function playSound() {
            // Check if audio context is running, if not, try to resume/start
            if (Tone.context.state !== 'running') {
                await Tone.start();
                console.log("AudioContext resumed.");
            }
            if (synth) {
                // Play a C4 note for 0.1 seconds
                synth.triggerAttackRelease("C4", "8n");
                console.log("Sound played.");
            } else {
                console.warn("Synth not initialized. Cannot play sound.");
            }
        }


        // MARK: - Timer Logic Variables
        let timerIntervalId;
        let timerRemainingTime;
        let isTimerPaused = false;
        let currentActiveTimerConfig = null; // Stores the config of the timer currently running
        let currentStepIndex = 0; // Tracks the current step for multi-step timers
        let currentRepeatRound = 1; // Tracks the current repeat round
        let editingTimerId = null; // Stores the ID of the timer being edited (null if creating new)


        // MARK: - DOM Elements
        const configListScreen = document.getElementById('configListScreen');
        const createTimerScreen = document.getElementById('createTimerScreen');
        const timerScreen = document.getElementById('timerScreen');
        const currentTimerDisplay = document.getElementById('currentTimerDisplay');
        const timerScreenTitle = document.getElementById('timerScreenTitle');
        const startButtonTimer = document.getElementById('startButtonTimer');
        const pauseButtonTimer = document.getElementById('pauseButtonTimer');
        const backButton = document.getElementById('backButton');
        const doneScreen = document.getElementById('doneScreen');
        const addCustomTimerButton = document.getElementById('addCustomTimerButton');
        const newTimerNameInput = document.getElementById('newTimerName');
        const timerNameHint = document.getElementById('timerNameHint'); // Get the new hint element

        // Create Timer Screen specific elements
        const timerStepsContainer = document.getElementById('timerStepsContainer');
        const dynamicStepItemsWrapper = document.getElementById('dynamicStepItemsWrapper'); // New wrapper for dynamic steps
        const addStepButton = document.getElementById('addStepButton');
        const repeatTimesSelect = document.getElementById('repeatTimesSelect'); // New repeat select element
        const createTimerConfirmButton = document.getElementById('createTimerConfirmButton');
        const cancelCreateTimerButton = document.getElementById('cancelCreateTimerButton');
        const presetTimersList = document.getElementById('presetTimersList');

        // Array to hold the steps being configured on the create page
        let currentCreatingSteps = [];


        /**
         * Formats seconds into MM:SS string.
         * @param {number} totalSeconds - The total number of seconds.
         * @returns {string} Formatted time string (MM:SS).
         */
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        /**
         * Updates the timer screen title to reflect the current step and round.
         */
        function updateTimerScreenTitle() {
            if (currentActiveTimerConfig && currentActiveTimerConfig.steps.length > 0) {
                const currentStep = currentActiveTimerConfig.steps[currentStepIndex];
                const totalSteps = currentActiveTimerConfig.steps.length;
                const totalRounds = currentActiveTimerConfig.repeatCount;

                let titleHtml = `${currentActiveTimerConfig.name} - ${currentStep.type}`;
                if (totalRounds > 1 || totalSteps > 1) { // Only add second line if there's multi-round or multi-step info
                    titleHtml += '<br>'; // Add a line break
                    let detailText = '';
                    if (totalRounds > 1) {
                        detailText += `Round ${currentRepeatRound}/${totalRounds}`;
                    }
                    if (totalSteps > 1) {
                        if (detailText !== '') {
                            detailText += ', ';
                        }
                        detailText += `Step ${currentStepIndex + 1}/${totalSteps}`;
                    }
                    titleHtml += detailText;
                }
                timerScreenTitle.innerHTML = titleHtml; // Use innerHTML to render the <br> tag
            }
        }

        /**
         * Starts or resumes the timer.
         */
        function startTimer() {
            initializeAudio(); // Initialize audio context on user interaction
            if (timerIntervalId) {
                clearInterval(timerIntervalId); // Clear any existing interval to prevent duplicates
            }
            isTimerPaused = false;
            startButtonTimer.disabled = true;
            pauseButtonTimer.disabled = false;

            updateTimerScreenTitle(); // Update title when timer starts/resumes

            timerIntervalId = setInterval(() => {
                if (timerRemainingTime > 0) {
                    timerRemainingTime--;
                    currentTimerDisplay.textContent = formatTime(timerRemainingTime);
                } else {
                    clearInterval(timerIntervalId);
                    timerIntervalId = null;
                    handleTimerCompletion();
                }
            }, 1000);
        }

        /**
         * Pauses the timer.
         */
        function pauseTimer() {
            clearInterval(timerIntervalId);
            timerIntervalId = null;
            isTimerPaused = true;
            startButtonTimer.disabled = false;
            pauseButtonTimer.disabled = true;
        }

        /**
         * Handles what happens when the timer reaches 0.
         * Implements multi-step and multi-round timer progression.
         */
        function handleTimerCompletion() {
            console.log(`Step ${currentStepIndex + 1} completed.`);
            // Play sound based on the completed step's configuration
            if (currentActiveTimerConfig && currentActiveTimerConfig.steps[currentStepIndex].hasVoiceAction) {
                playSound();
            }
            // Future enhancement: Implement vibration action here if supported by the environment.

            currentStepIndex++; // Move to the next step

            // Check if there are more steps in the current round
            if (currentStepIndex < currentActiveTimerConfig.steps.length) {
                // More steps in the current round
                timerRemainingTime = currentActiveTimerConfig.steps[currentStepIndex].duration;
                console.log(`Moving to next step: ${currentActiveTimerConfig.steps[currentStepIndex].type} for ${timerRemainingTime}s`);
                startTimer(); // Start the next step immediately
            } else {
                // All steps in the current round are done
                currentRepeatRound++; // Move to the next repeat round
                // Check if there are more repeats
                if (currentRepeatRound <= currentActiveTimerConfig.repeatCount) {
                    // More rounds to repeat
                    currentStepIndex = 0; // Reset step index for the new round
                    timerRemainingTime = currentActiveTimerConfig.steps[currentStepIndex].duration; // Get duration of the first step of the new round
                    console.log(`Starting new round ${currentRepeatRound}/${currentActiveTimerConfig.repeatCount}. First step: ${currentActiveTimerConfig.steps[currentStepIndex].type} for ${timerRemainingTime}s`);
                    startTimer(); // Start the new round immediately
                } else {
                    // All rounds are done
                    console.log("All timer steps and rounds completed.");
                    showDoneScreen();
                }
            }
        }

        /**
         * Shows the "Done!" screen and then returns to the home page.
         */
        function showDoneScreen() {
            timerScreen.classList.add('hidden'); // Hide the timer screen
            doneScreen.classList.add('visible'); // Show the done screen overlay

            setTimeout(() => {
                doneScreen.classList.remove('visible'); // Hide after 2 seconds
                showConfigList(); // Go back to home page
            }, 2000);
        }

        // MARK: - Navigation Functions

        /**
         * Navigates to the timer screen and starts the first step.
         * @param {string} configId - The ID of the timer configuration to display.
         * @param {boolean} [isPreset=false] - True if the configId refers to a preset timer.
         */
        function showTimerScreen(configId, isPreset = false) {
            configListScreen.classList.add('hidden');
            createTimerScreen.classList.add('hidden'); // Hide create screen too
            timerScreen.classList.remove('hidden');

            const sourceArray = isPreset ? presetTimerConfigurations : timerConfigurations;
            const selectedConfig = sourceArray.find(c => c.id === configId);

            if (selectedConfig && selectedConfig.steps && selectedConfig.steps.length > 0) {
                currentActiveTimerConfig = selectedConfig; // Store the active config
                currentStepIndex = 0; // Start from the first step
                currentRepeatRound = 1; // Start from the first round

                timerRemainingTime = currentActiveTimerConfig.steps[currentStepIndex].duration;
                
                isTimerPaused = false; // Ensure timer starts unpaused

                currentTimerDisplay.textContent = formatTime(timerRemainingTime);
                updateTimerScreenTitle(); // Initial title update

                startButtonTimer.disabled = false; // Enable start button on load
                pauseButtonTimer.disabled = true; // Disable pause until started

                // Automatically start the timer when navigating to the timer screen
                startTimer();
            } else {
                console.error("Selected timer configuration is invalid or has no steps.");
                showConfigList(); // Go back to home if config is bad
            }
        }

        /**
         * Navigates back to the configuration list screen (home page).
         */
        function showConfigList() {
            // Stop any running timer when returning to the home screen
            clearInterval(timerIntervalId);
            timerIntervalId = null;
            isTimerPaused = false;
            currentActiveTimerConfig = null; // Clear active config
            currentStepIndex = 0; // Reset step index
            currentRepeatRound = 1; // Reset repeat round

            createTimerScreen.classList.add('hidden'); // Hide create screen
            timerScreen.classList.add('hidden'); // Hide timer screen
            configListScreen.classList.remove('hidden');

            // Reset create/update button state
            editingTimerId = null;
            createTimerConfirmButton.textContent = 'Submit'; // Changed button text
            newTimerNameInput.classList.remove('input-invalid'); // Clear invalid style
            timerNameHint.classList.add('hidden'); // Hide hint

            renderTimerConfigurations(); // Re-render to ensure any new timers are shown
            renderPresetTimerConfigurations(); // Re-render presets too
        }

        /**
         * Navigates to the Create Timer screen, optionally pre-populating for editing.
         * @param {string} [configId=null] - The ID of the timer configuration to edit. If null, a new timer is created.
         * @param {boolean} [isPreset=false] - True if the configId refers to a preset timer.
         */
        function showCreateTimerScreen(configId = null, isPreset = false) {
            configListScreen.classList.add('hidden');
            timerScreen.classList.add('hidden');
            createTimerScreen.classList.remove('hidden');

            // Reset UI elements
            newTimerNameInput.value = '';
            timerNameHint.classList.add('hidden');
            newTimerNameInput.classList.remove('input-invalid');

            let configToLoad = null;
            if (isPreset) {
                configToLoad = presetTimerConfigurations.find(c => c.id === configId);
                if (configToLoad) {
                    // When editing a preset, we just load its data into the form.
                    // We DO NOT add it to timerConfigurations yet.
                    // It will be added as a *new* custom timer only upon "Submit".
                    editingTimerId = null; // Crucial: Treat it as a new creation, not an edit of an existing custom timer
                    newTimerNameInput.value = configToLoad.name;
                    currentCreatingSteps = configToLoad.steps.map(step => new TimerStep(step.type, step.duration, step.hasVoiceAction, step.hasVibrationAction));
                    repeatTimesSelect.value = configToLoad.repeatCount;
                    createTimerConfirmButton.textContent = 'Submit'; // Always "Submit" for new creations
                } else {
                    console.error("Preset config to edit not found:", configId);
                    // Fallback to creating a new timer if preset ID is invalid
                    editingTimerId = null;
                    createTimerConfirmButton.textContent = 'Submit';
                    currentCreatingSteps = [new TimerStep("Work", 60, true, true)];
                    repeatTimesSelect.value = 1;
                }
            } else if (configId) {
                // Editing an existing custom timer
                editingTimerId = configId;
                createTimerConfirmButton.textContent = 'Submit';
                configToLoad = timerConfigurations.find(c => c.id === configId);
                if (configToLoad) {
                    newTimerNameInput.value = configToLoad.name;
                    // Deep copy steps to avoid modifying the original config directly
                    currentCreatingSteps = configToLoad.steps.map(step => new TimerStep(step.type, step.duration, step.hasVoiceAction, step.hasVibrationAction));
                    repeatTimesSelect.value = configToLoad.repeatCount;
                } else {
                    console.error("Custom config to edit not found:", configId);
                    // Fallback to creating a new timer if ID is invalid
                    editingTimerId = null;
                    createTimerConfirmButton.textContent = 'Submit';
                    currentCreatingSteps = [new TimerStep("Work", 60, true, true)];
                    repeatTimesSelect.value = 1;
                }
            } else {
                // Creating a new timer (blank)
                editingTimerId = null;
                createTimerConfirmButton.textContent = 'Submit';
                currentCreatingSteps = [new TimerStep("Work", 60, true, true)]; // Start with one default step
                repeatTimesSelect.value = 1; // Default to 1x (no repeat)
            }

            // Populate repeatTimesSelect options (always do this to ensure it's fresh)
            repeatTimesSelect.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}x`;
                repeatTimesSelect.appendChild(option);
            }
            // Ensure the selected value is set after options are populated
            if (configToLoad) { // Use configToLoad which holds either the preset or custom timer
                repeatTimesSelect.value = configToLoad.repeatCount;
            } else {
                repeatTimesSelect.value = 1;
            }

            renderCreateTimerSteps();
        }

        // MARK: - Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Timer control buttons
            if (startButtonTimer) {
                startButtonTimer.addEventListener('click', startTimer);
            }
            if (pauseButtonTimer) {
                pauseButtonTimer.addEventListener('click', pauseTimer);
            }
            if (backButton) {
                backButton.addEventListener('click', showConfigList);
            }

            // Home screen buttons
            if (addCustomTimerButton) {
                addCustomTimerButton.addEventListener('click', () => showCreateTimerScreen(null)); // Pass null for new timer
            }

            // Create Timer screen buttons
            if (createTimerConfirmButton) {
                createTimerConfirmButton.addEventListener('click', () => {
                    console.log("Create/Update Timer button clicked.");
                    const name = newTimerNameInput.value.trim();

                    if (!name) {
                        timerNameHint.textContent = 'Please enter a timer name.';
                        timerNameHint.classList.remove('hidden');
                        newTimerNameInput.classList.add('input-invalid');
                        console.warn("Validation: Timer name is empty. Please provide a name.");
                        return;
                    } else {
                        timerNameHint.classList.add('hidden');
                        newTimerNameInput.classList.remove('input-invalid');
                    }

                    const stepsData = [];
                    const stepItems = dynamicStepItemsWrapper.querySelectorAll('.timer-step-item');
                    let isValid = true;

                    Array.from(stepItems).forEach((item, idx) => {
                        const typeSelect = item.querySelector('.step-label-select');
                        const durationSelect = item.querySelector('.step-duration-select');
                        const voiceCheckbox = item.querySelector('input[type="checkbox"][data-action="voice"]');
                        const vibrationCheckbox = item.querySelector('input[type="checkbox"][data-action="vibration"]');

                        const type = typeSelect ? typeSelect.value : "Work";
                        const duration = durationSelect ? parseInt(durationSelect.value, 10) : 0;
                        const hasVoice = voiceCheckbox ? voiceCheckbox.checked : false;
                        const hasVibration = vibrationCheckbox ? vibrationCheckbox.checked : false;

                        if (isNaN(duration) || duration <= 0) {
                            isValid = false;
                            console.error(`Validation failed: Step ${idx + 1} duration is invalid (${duration}).`);
                            return;
                        }
                        stepsData.push(new TimerStep(type, duration, hasVoice, hasVibration));
                    });

                    if (!isValid) {
                        alert('Please ensure all step durations are valid positive numbers.');
                        return;
                    }
                    if (stepsData.length === 0) {
                        alert('Please add at least one step to your timer.');
                        console.error("Validation failed: No steps added.");
                        return;
                    }

                    const selectedRepeatCount = parseInt(repeatTimesSelect.value, 10);
                    console.log(`Collected data: Name="${name}", Steps count=${stepsData.length}, Repeat count=${selectedRepeatCount}`);

                    if (editingTimerId) {
                        // Update existing timer
                        const indexToUpdate = timerConfigurations.findIndex(c => c.id === editingTimerId);
                        if (indexToUpdate > -1) {
                            timerConfigurations[indexToUpdate].name = name;
                            timerConfigurations[indexToUpdate].steps = stepsData;
                            timerConfigurations[indexToUpdate].repeatCount = selectedRepeatCount;
                            console.log("Timer updated. Current timerConfigurations:", timerConfigurations);
                        } else {
                            console.error("Error: Timer with ID", editingTimerId, "not found for update.");
                        }
                    } else {
                        // Create new timer (including from a preset copy)
                        timerConfigurations.push(new TimerConfiguration(name, stepsData, selectedRepeatCount));
                        console.log("New timer added. Current timerConfigurations:", timerConfigurations);
                    }

                    showConfigList();
                    console.log("Returned to home page.");
                });
            }
            if (cancelCreateTimerButton) {
                cancelCreateTimerButton.addEventListener('click', showConfigList); // Return to home
            }

            // Event listener to hide the hint when user starts typing in the name input
            if (newTimerNameInput) {
                newTimerNameInput.addEventListener('input', () => {
                    if (timerNameHint && !timerNameHint.classList.contains('hidden')) {
                        timerNameHint.classList.add('hidden');
                    }
                    newTimerNameInput.classList.remove('input-invalid');
                });
            }


            // If addStepButton exists, add its event listener
            if (addStepButton) {
                addStepButton.addEventListener('click', () => {
                    // Add a new step, defaulting to 60s Work with voice/vibration
                    currentCreatingSteps.push(new TimerStep("Work", 60, true, true));
                    renderCreateTimerSteps();
                    console.log("New step added. Current creating steps:", currentCreatingSteps);
                });
            }

            // Global click listener to initialize audio context on first user interaction
            document.body.addEventListener('click', initializeAudio, { once: true });

            // Initial renders when the page loads
            renderTimerConfigurations();
            renderPresetTimerConfigurations();
        });


        // MARK: - Render Functions

        /**
         * Renders the list of user's custom timer configurations into the DOM.
         */
        function renderTimerConfigurations() {
            const listElement = document.getElementById('timerConfigList');
            listElement.innerHTML = ''; // Clear existing list items
            console.log("renderTimerConfigurations called. Current custom configurations to render:", timerConfigurations);

            if (timerConfigurations.length === 0) {
                const noTimersMessage = document.createElement('li');
                noTimersMessage.className = 'text-center text-gray-500 py-4';
                noTimersMessage.textContent = 'No custom timers yet. Create one!';
                listElement.appendChild(noTimersMessage);
            }

            timerConfigurations.forEach((config, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'config-item';

                // Make the entire list item clickable for editing
                listItem.addEventListener('click', (event) => {
                    // Prevent event from bubbling up if a button inside is clicked
                    if (!event.target.closest('.action-button')) {
                        showCreateTimerScreen(config.id); // Navigate to edit screen
                    }
                });


                // --- 1. Index Number ---
                const indexSpan = document.createElement('span');
                indexSpan.className = 'item-index';
                indexSpan.textContent = index + 1; // 1-based index
                listItem.appendChild(indexSpan);

                // --- Item Name (Displaying "Name" from config) ---
                const itemNameSpan = document.createElement('span');
                itemNameSpan.className = 'item-name';
                
                let totalWorkTime = 0;
                let totalRestTime = 0;
                let totalDuration = 0;

                config.steps.forEach(step => {
                    totalDuration += step.duration;
                    if (step.type === "Work") {
                        totalWorkTime += step.duration;
                    } else if (step.type === "Rest") {
                        totalRestTime += step.duration;
                    }
                });

                // Adjust total times by repeat count
                const overallTotalDuration = totalDuration * config.repeatCount;
                const overallWorkTime = totalWorkTime * config.repeatCount;
                const overallRestTime = totalRestTime * config.repeatCount;

                let repeatText = "";
                if (config.repeatCount > 1) {
                    repeatText = `, Repeat: ${config.repeatCount}x`;
                } else if (config.repeatCount === 0) { // Future consideration for infinite repeat
                    repeatText = ", Repeat: Infinite";
                }
                
                itemNameSpan.textContent = `${config.name} (Total: ${formatTime(overallTotalDuration)}, W: ${formatTime(overallWorkTime)}, R: ${formatTime(overallRestTime)}${repeatText})`;
                listItem.appendChild(itemNameSpan);

                // Group for action buttons (Start and Remove)
                const actionButtonsGroup = document.createElement('div');
                actionButtonsGroup.className = 'flex items-center gap-4';


                // --- Start Button with Icon ---
                const startButton = document.createElement('button');
                startButton.className = 'action-button start-button';
                startButton.innerHTML = svgIcons.play;
                startButton.title = `Start ${config.name || 'timer'}`;
                startButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent listItem click from firing
                    showTimerScreen(config.id); // Pass the config ID to the timer screen
                });
                actionButtonsGroup.appendChild(startButton);

                // --- Remove Button ---
                const removeButton = document.createElement('button');
                removeButton.className = 'action-button remove-button';
                removeButton.innerHTML = svgIcons.remove;
                removeButton.title = `Remove ${config.name || 'timer'}`;
                removeButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent listItem click from firing
                    const indexToRemove = timerConfigurations.findIndex(c => c.id === config.id);
                    if (indexToRemove > -1) {
                        timerConfigurations.splice(indexToRemove, 1); // Remove the item from the array
                        renderTimerConfigurations(); // Re-render the list
                    }
                });
                actionButtonsGroup.appendChild(removeButton);

                listItem.appendChild(actionButtonsGroup);
                listElement.appendChild(listItem);
            });
            console.log("Custom timers rendered.");
        }

        /**
         * Renders the list of preset timer configurations into the DOM.
         */
        function renderPresetTimerConfigurations() {
            const listElement = document.getElementById('presetTimersList');
            listElement.innerHTML = ''; // Clear existing list items
            console.log("renderPresetTimerConfigurations called. Current preset configurations to render:", presetTimerConfigurations);


            presetTimerConfigurations.forEach((presetConfig) => {
                const listItem = document.createElement('li');
                listItem.className = 'preset-item';

                // Make the entire list item clickable for editing (creates a custom copy)
                listItem.addEventListener('click', (event) => {
                    // Prevent event from bubbling up if a button inside is clicked
                    if (!event.target.closest('.action-button')) {
                        showCreateTimerScreen(presetConfig.id, true); // Pass true to indicate it's a preset
                    }
                });

                // --- Preset Name ---
                const presetNameSpan = document.createElement('span');
                presetNameSpan.className = 'item-name';

                let totalWorkTime = 0;
                let totalRestTime = 0;
                let totalDuration = 0;

                presetConfig.steps.forEach(step => {
                    totalDuration += step.duration;
                    if (step.type === "Work") {
                        totalWorkTime += step.duration;
                    } else if (step.type === "Rest") {
                        totalRestTime += step.duration;
                    }
                });

                // Adjust total times by repeat count
                const overallTotalDuration = totalDuration * presetConfig.repeatCount;
                const overallWorkTime = totalWorkTime * presetConfig.repeatCount;
                const overallRestTime = totalRestTime * presetConfig.repeatCount;

                let repeatText = "";
                if (presetConfig.repeatCount > 1) {
                    repeatText = `, Repeat: ${presetConfig.repeatCount}x`;
                } else if (presetConfig.repeatCount === 0) { // Future consideration for infinite repeat
                    repeatText = ", Repeat: Infinite";
                }

                // Updated to display the new preset names along with the full summary
                presetNameSpan.textContent = `${presetConfig.name} (Total: ${formatTime(overallTotalDuration)}, W: ${formatTime(overallWorkTime)}, R: ${formatTime(overallRestTime)}${repeatText})`;
                listItem.appendChild(presetNameSpan);

                // Group for action buttons (Start and Add Preset)
                const actionButtonsGroup = document.createElement('div');
                actionButtonsGroup.className = 'flex items-center gap-4';

                // --- Start Button with Icon (for presets) ---
                const startButton = document.createElement('button');
                startButton.className = 'action-button start-button';
                startButton.innerHTML = svgIcons.play;
                startButton.title = `Start ${presetConfig.name || 'preset timer'}`;
                startButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent listItem click from firing
                    showTimerScreen(presetConfig.id, true); // Pass true to indicate it's a preset
                });
                actionButtonsGroup.appendChild(startButton);

                // --- Add Preset Button ---
                const addPresetButton = document.createElement('button');
                addPresetButton.className = 'action-button add-preset-button';
                addPresetButton.innerHTML = svgIcons.add;
                addPresetButton.title = `Add ${presetConfig.name}`;
                addPresetButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent listItem click from firing
                    // Create a deep copy of the preset's steps to avoid reference issues
                    const newSteps = presetConfig.steps.map(step => new TimerStep(step.type, step.duration, step.hasVoiceAction, step.hasVibrationAction));
                    // Push with the preset's repeatCount
                    timerConfigurations.push(new TimerConfiguration(presetConfig.name, newSteps, presetConfig.repeatCount));
                    renderTimerConfigurations(); // Re-render the main list
                    console.log(`Preset "${presetConfig.name}" added to custom timers.`);
                });
                actionButtonsGroup.appendChild(addPresetButton);

                listItem.appendChild(actionButtonsGroup);
                listElement.appendChild(listItem);
            });
            console.log("Preset timers rendered.");
        }

        /**
         * Renders the steps on the Create Timer screen based on currentCreatingSteps array.
         */
        function renderCreateTimerSteps() {
            dynamicStepItemsWrapper.innerHTML = ''; // Clear existing steps in the dynamic wrapper
            console.log("renderCreateTimerSteps called. Current steps to render:", currentCreatingSteps);


            currentCreatingSteps.forEach((step, index) => {
                const stepItemDiv = document.createElement('div');
                stepItemDiv.className = 'timer-step-item';

                // Index
                const indexSpan = document.createElement('span');
                indexSpan.className = 'step-index';
                indexSpan.textContent = index + 1;
                stepItemDiv.appendChild(indexSpan);

                // Type (Work/Rest) Select
                const typeSelect = document.createElement('select');
                typeSelect.className = 'step-label-select';
                typeSelect.setAttribute('data-step-property', 'type');
                typeSelect.innerHTML = `
                    <option value="Work" ${step.type === "Work" ? 'selected' : ''}>Work</option>
                    <option value="Rest" ${step.type === "Rest" ? 'selected' : ''}>Rest</option>
                `;
                typeSelect.addEventListener('change', (e) => {
                    currentCreatingSteps[index].type = e.target.value;
                    console.log(`Step ${index + 1} type changed to: ${e.target.value}`);
                });
                stepItemDiv.appendChild(typeSelect);

                // Duration Select
                const durationSelect = document.createElement('select');
                durationSelect.className = 'step-duration-select';
                durationSelect.setAttribute('data-step-property', 'duration');
                
                // Add all predefined options
                stepDurationOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    durationSelect.appendChild(optionElement);
                });

                // If the current step's duration is not in the predefined options, add it dynamically
                const isDurationPredefined = stepDurationOptions.some(option => option.value === step.duration);
                if (!isDurationPredefined) {
                    const customOption = document.createElement('option');
                    customOption.value = step.duration;
                    customOption.textContent = formatTime(step.duration); // Format custom duration
                    durationSelect.prepend(customOption); // Prepend to show it first
                }

                durationSelect.value = step.duration; // Set initial value
                durationSelect.addEventListener('change', (e) => {
                    currentCreatingSteps[index].duration = parseInt(e.target.value, 10);
                    console.log(`Step ${index + 1} duration changed to: ${e.target.value}s`);
                });
                stepItemDiv.appendChild(durationSelect);

                // Voice Action Checkbox
                const voiceLabel = document.createElement('label');
                voiceLabel.className = 'step-action-checkbox';
                voiceLabel.innerHTML = `
                    <input type="checkbox" ${step.hasVoiceAction ? 'checked' : ''} data-action="voice">
                    ${svgIcons.voice}
                `;
                voiceLabel.title = "Voice Alert";
                voiceLabel.querySelector('input').addEventListener('change', (e) => {
                    currentCreatingSteps[index].hasVoiceAction = e.target.checked;
                    console.log(`Step ${index + 1} voice action: ${e.target.checked}`);
                });
                stepItemDiv.appendChild(voiceLabel);

                // Vibration Action Checkbox
                const vibrationLabel = document.createElement('label');
                vibrationLabel.className = 'step-action-checkbox';
                vibrationLabel.innerHTML = `
                    <input type="checkbox" ${step.hasVibrationAction ? 'checked' : ''} data-action="vibration">
                    ${svgIcons.vibration}
                `;
                vibrationLabel.title = "Vibration Alert";
                vibrationLabel.querySelector('input').addEventListener('change', (e) => {
                    currentCreatingSteps[index].hasVibrationAction = e.target.checked;
                    console.log(`Step ${index + 1} vibration action: ${e.target.checked}`);
                });
                stepItemDiv.appendChild(vibrationLabel);

                // Remove Step Item Button
                const removeStepItemButton = document.createElement('button');
                removeStepItemButton.className = 'remove-step-item-button';
                removeStepItemButton.innerHTML = svgIcons.remove;
                removeStepItemButton.title = `Remove Step ${index + 1}`;
                removeStepItemButton.addEventListener('click', () => {
                    // Only allow removal if there's more than one step
                    if (currentCreatingSteps.length > 1) {
                        currentCreatingSteps.splice(index, 1); // Remove this specific step
                        renderCreateTimerSteps(); // Re-render to update indices and buttons
                        console.log(`Step ${index + 1} removed.`);
                    } else {
                        alert("You must have at least one step in your timer.");
                        console.warn("Attempted to remove the last step. At least one step is required.");
                    }
                });
                // Disable if it's the only step
                if (currentCreatingSteps.length <= 1) {
                    removeStepItemButton.disabled = true;
                }
                stepItemDiv.appendChild(removeStepItemButton);


                dynamicStepItemsWrapper.appendChild(stepItemDiv); // Append to the dynamic wrapper
            });
            console.log("Create timer steps rendered.");
        }
    </script>
</body>
</html>

